---

# Usage:
  #   ansible-playbook -b -K -c local -i "127.0.0.1," -l 127.0.0.1 \
#     ./bootstrap.system.playbook.yml


- hosts: all
  name: Install system updates
  tags:
  - updates
  - become
  tasks:

  # update security, then update all
  - name: update security packages
    command: dnf update -y --security --sec-severity Low
    become: true
    register: dnfupdate
    when:
    - skip_updates is not defined
    changed_when: "dnfupdate.stdout_lines[-2:] != ['Nothing to do.','Complete!']"
  - name: update all packages
    become: true
    dnf:
      name: '*'
      state: latest


- hosts: all
  name: Install openssh-server
  tags:
  - ssh
  - become
  tasks:
  - name: Install openssh-server
    become: true
    package:
      name: openssh-server
      state: present
    when:
      - not ansible_is_chroot


  - name: Enable openssh-server
    become: true
    service:
      name: sshd
      state: started
      enabled: true
    when:
      - not ansible_is_chroot

  #roles:
  #- dev-sec.ssh-hardening

- hosts: all
  name: Install virtualenv, virtualenvwrapper, pip, pipx
  tags:
  - dotfiles
  - virtualenv
  - virtualenvwrapper
  - pipx
  tasks:
  - name: "Install virtualenv, virtualenvwrapper, pipx"
    become: true
    dnf:
      name:
      #- python2-virtualenv
      #- python2-virtualenvwrapper
      - python3-wheel
      - python3-pip
      - python3-virtualenvwrapper
      - pipx
      state: present

- hosts: all
  name: Configure grub
  tags:
  - grub
  tasks:
  - name: "Check whether grub2-editenv is on $PATH"
    command: command -v grub2-editenv
    ignore_errors: true
    register: grub2editenv_result
    failed_when: "grub2editenv_result.rc not in [0,1]"
    changed_when: "False"
  - name: "Always show the grub boot menu"
    become: true
    command: grub2-editenv - unset "menu_auto_hide"
    when:
      - "grub2editenv_result.rc == 0"
